<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Machinae Security Intelligence Collector</title>

    <!-- Bootstrap -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.8.1/bootstrap-table.min.css">

    <style>
      .nav-tabs {
        margin-bottom: 15px;
      }
    </style>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="row">
      <div class="col-sm-6 col-sm-offset-3">
        <h1>Machinae Security Intelligence Collector</h1>

        <form id="machinaeForm">
          <div class="form-group">
            <label for="target" class="h4">Target</label>
            <input type="text" class="form-control" id="target" placeholder="Target..." >
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-primary pull-right ">
              Analyze
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1>Processing...</h1>
          </div>
          <div class="modal-body">
            <div class="progress">
              <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="machinaeModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="machinaeModalTitle"></h4>
          </div>
          <div class="modal-body" id="machinaeResponseBody">
            <div class="progress" id="progress">
              <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>

            <div>
              <ul class="nav nav-tabs" role="tablist" id="modalTabs"></ul>
              <div class="tab-content" id="modalTabContents"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.8.1/bootstrap-table.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.js"></script>

    <script type="text/javascript">
      function formatResult(result) {
        if ($.isArray(result)) {
          return result.join(", ")
        } else {
          return result;
        }
      }

      $("#machinaeForm").on("submit", function(event) {
        event.preventDefault();
        var target = $("#target").val();

        $.ajax({
          type: "GET",
          url: "//api.machinae-app.io/" + target,
          beforeSend: function(xhr, settings) {
            $("#machinaeModalTitle").text("Processing...");

            $("#modalTabs").hide();
            $("#modalTabContents").hide();
            $("#machinaeModal").modal();
          },
          success: function(response) {
            $("#modalTabs").empty();
            $("#modalTabContents").empty();

            $.each(response, function(idx, item) {
              var siteName = item.site;
              var tabName = siteName.toLowerCase().replace(" ", "_")

              if ($.isEmptyObject(item.results)) {
                var modalTable = $("<div>").attr({
                  class: "alert alert-danger"
                }).append("No results found")
              } else {
                var modalTable = $("<dl>").attr({
                  class: "dl-horizontal",
                });

                $.each(item.results, function(pretty_name, value) {
                  if ($.isArray(value)) {
                    var cellContents = $("<ul>").attr({
                      class: "list-unstyled"
                    });
                    $.each(value, function(idxx, row) {
                      cellContents.append(
                        $("<li>").append(formatResult(row))
                      );
                    })
                  } else {
                    var cellContents = formatResult(value);
                  }
                  modalTable.append(
                    $("<dt>").append(pretty_name),
                    $("<dd>").append(cellContents)
                  );
                });
              }

              // Append tab
              $("#modalTabs").append(
                $("<li>").attr({
                  role: "presentation"
                }).append(
                  $("<a>").attr({
                    href: "#" + tabName,
                    'aria-controls': "settings",
                    role: "tab",
                    'data-toggle': "tab",
                    id: "tab_" + tabName
                  }).append(siteName)
                )
              );

              // Append tab panel
              $("#modalTabContents").append(
                $("<div>").attr({
                  role: "tabpanel",
                  class: "tab-pane",
                  id: tabName
                }).append(modalTable)
              );

              // If this is the first tab, activate it
              if (idx == 0) {
                $("#tab_" + tabName).tab("show");
              }
            })

            $("#machinaeModalTitle").text("Results for: " + target);
            $("#progress").hide();
            $("#modalTabs").show();
            $("#modalTabContents").show();
          }
        })
      });
    </script>
  </body>
</html>
